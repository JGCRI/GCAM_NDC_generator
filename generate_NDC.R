#==================================================================================
#!/usr/bin/env Rscript
#
# LEGAL NOTICE
# This computer software was prepared by Battelle Memorial Institute,
# hereinafter the Contractor, under Contract No. DE-AC05-76RL0 1830
# with the Department of Energy (DOE). NEITHER THE GOVERNMENT NOR THE
# CONTRACTOR MAKES ANY WARRANTY, EXPRESS OR IMPLIED, OR ASSUMES ANY
# LIABILITY FOR THE USE OF THIS SOFTWARE. This notice including this
# sentence must appear on any copies of this computer software.
#
# EXPORT CONTROL
# User agrees that the Software will not be shipped, transferred or
# exported into any country or used in any manner prohibited by the
# United States Export Administration Act or any other applicable
# export laws, restrictions or regulations (collectively the "Export Laws").
# Export of the Software may require some form of license or other
# authority from the U.S. Government, and failure to obtain such
# export control license may result in criminal liability under
# U.S. laws. In addition, if the Software is identified as export controlled
# items under the Export Laws, User represents and warrants that User
# is not a citizen, or otherwise located within, an embargoed nation
# (including without limitation Iran, Syria, Sudan, Cuba, and North Korea)
#     and that User is not otherwise prohibited
# under the Export Laws from receiving the Software.
#
# Copyright 2011 Battelle Memorial Institute.  All Rights Reserved.
# Distributed as open-source under the terms of the Educational Community
# License version 2.0 (ECL 2.0). http://www.opensource.org/licenses/ecl2.php
#
# For further details, see: http://www.globalchange.umd.edu/models/gcam/
#
#==================================================================================

#This document generates NDC constraints for GCAM by taking in baseline emissions and baseline GDP
#and creating constratins consistent with the iNDCs based off these values. As GCAM currently has a base year
#of 2015 the reference case the iNDCs are based off of will be essentially a BAU without the NDCs as
#little action had taken place by 2015. When GCAM moves its base year forward new considerations will need to be
#taken to alter this script. NOTE: GHG emissions price modifiers are based off of AR4
#JEH June 2019

#TO DO
#   Allow regions to specify their own demand adjuster (AR4, AR5, etc)
#   Alter values for indicative targets

#This version of the script uses AR4 to judge GHGs, but countries based their constraints off of several studies,
#so this could be updated to be region specific.


####Ben/Page's MI parser script####
# An automated graphing system to process GCAM output data (as generated by the
# ModelInterface) and generate both standard and user-defined graphs.
#
# This file is the main entry point to the backend system.
#
# Original backend module developed by Ben Bond-Lamberty, November 2012
# Modified by GPK, May 2017

# See https://cran.r-project.org/web/packages/argparser/argparser.pdf

datestamp <- gsub("-", "_", Sys.Date())

loadScripts <- function(names) {
  for (name in names) {
    pathname = file.path("R", name)
    source(pathname)
  }
}
# Load all support functions into memory
loadScripts(c("diag_header.R",             # configuration and helper functions
              "diag_parser.R",             # parser to read "ModelInterface" style CSVs
              "diag_util_functions.R",     # useful utility functions
              "GHG_CO2e.R"))               # converter for GHGs to their CO2e values


####Establish constants####
OUTPUT_DIR <- "output"
QUERY_DIR <- file.path("data", "queries")
MAPPING_DIR <- file.path("data", "mapping")
DATA_DIR <- file.path("data", "commitments")
HIST_EMIS <- file.path("data", "hist_emissions")


#This header is attached to csv tables to have easily manipulable files

LINK_FILE_HEADER <- "INPUT_TABLE\nVariable ID\nGHGLink_start\n"


#These GCAM regions are individual countries (other than australia_NZ), and so don't require the
#aggregation scheme applied to the other regions

UNAGGREGATED_CONSTRAINTS <- c("USA", "Australia_NZ", "Brazil",
                              "Canada", "China", "EU",
                              "India", "Indonesia", "Japan",
                              "Mexico", "Pakistan", "Russia",
                              "South Africa", "South Korea",
                              "Taiwan", "Argentina", "Colombia")

#If there's any market you want to remove eg the US after it recinded
#from the Paris accords
OMITTED_MARKETS <- c()

NDC_START_YEAR <- 2020
NDC_END_YEAR <- 2030
FIRST_PERIOD_AFTER_NDC_END <- 2035

LINK_COLS <- c("region", "linked.ghg.policy", "price.adjust.year", "price.adjust", "demand.adjust.year", "demand.adjust", "market", "linked.policy", "price.unit", "output.unit")


#####Source scripts, libraries, and create useful functions (NOTE: MARKET for EU-15 is specified in the function)####
#Write a csv with a head and tail (eg a csv with a header to run through the modelinterface)
#This is a specific case of the function below made for this script
write_const_csv <- function(x, file, f = write.csv, ...){
  header <- "INPUT_TABLE\nVariable ID\nGHGConstrLong\n"
  tail <- "\nINPUT_TABLE\nVariable ID\nGHGConstrMkt\n\nregion,ghgpolicy,market\nEU-15,GHG,EU"
  # create and open the file connection
  datafile <- file(file, open = 'wt')
  # close on exit
  on.exit(close(datafile))
  # if a header is defined, write it to the file
  writeLines(header,con=datafile)
  # write the file using the defined function and required addition arguments
  f(x, datafile,...)
  # write the tail of the csv
  writeLines(tail, con=datafile)
}

#Write a csv with a head and tail (eg a csv with a header to run through the modelinterface)
write_header_csv <- function(x, file, header, f = write.csv, ...){
  # create and open the file connection
  datafile <- file(file, open = 'wt')
  # close on exit
  on.exit(close(datafile))
  # if a header is defined, write it to the file
  writeLines(header,con=datafile)
  # write the file using the defined function and required addition arguments
  f(x, datafile,...)
}

#Take a wide formated csv and put years into a long format
gather_years <- function(.data){
  .data %>%
    gather(year, value, names(.)[grepl("[0-9]{4}", names(.))]) %>%
    mutate(year = as.integer(gsub("X", "", year))) %>%
    return()
}

####Read in mappings and important files [QUERY FILE SPECIFIED HERE]####

INDC_DATA <- read.csv(file.path(DATA_DIR, "INDC_const.csv"), as.is = TRUE)
COPPENHAGEN_DATA <- read.csv(file.path(DATA_DIR, "Coppenhagen_const.csv"), as.is = TRUE)


FILES <- c(file.path(QUERY_DIR, "NDC_QUERY.csv"))

tables <- list()
for( fn in FILES ) {
  tables[[ fn ]] <- parse_mi_output( fn )
}
emissions <- extract_data( "nonCO2 emissions by region",tables, FILES) %>% select(-date, -file)
gdp_mer <- extract_data( "GDP MER by region",tables, FILES) %>% select(-date, -file)
LU_emissions <- extract_data( "LUC emissions by region",tables, FILES) %>% select(-date, -file)

MARKET_MAPPING <- read.csv(file.path(MAPPING_DIR, "market_mapping.csv"), as.is = TRUE)
AR4_DEMAND_ADJUST <- read.csv(file.path(MAPPING_DIR, "AR4_demand_adjust.csv"), as.is = TRUE)
GHG_GROUP_MAPPING <- read.csv(file.path(MAPPING_DIR, "GHG_group_mapping.csv"), as.is = TRUE)
ISO_MAPPING <- read.csv(file.path(MAPPING_DIR, "iso_GCAM_regID.csv"), as.is = TRUE, comment.char = "#")
REGION_MAPPING <- read.csv(file.path(MAPPING_DIR, "GCAM_region_names.csv"), as.is = TRUE, comment.char = "#")
ISO_REGION_MAPPING <- left_join(ISO_MAPPING %>% select(iso, country_name, GCAM_region_ID), REGION_MAPPING)

####Create the GHG linking file####
#Certain countries only commited to certain gases or are ignoring LUC emissions
#This approach assumes all countries follow AR4 (though it shouldn't be too difficult to add others given data)
# and all countries within an aggregated region are committed to all ghgs and LUC (assumption)
INDC_DATA %>%
  filter(! rule %in% c("3a")) %>%
  left_join(MARKET_MAPPING, by = c(GCAM_region = "region")) %>%
  select(country, GCAM_region, market, CO2,	CH4,	N2O,	HFCs,	PFCs,	SF6, other_GHG, LULUCF) %>%
  gather(group, accounted, -c(country, GCAM_region, market)) %>%
  mutate(accounted = if_else(is.na(accounted), 0, as.double(accounted)))->
  NDC_link_data

#We get warning messages if we don't feed in a linking file for all periods, but we want to allow
#individual (or small aggregates such as australia_nz) to specifiy which gases and/or LUC emissions to omit
#We'll set all linkings to 0 then have the actual values read in by region in later periods to overwrite specific gases
ZEROED_AR4_DEMAND_ADJUST <- AR4_DEMAND_ADJUST %>% mutate(price.adjust = 0, demand.adjust = 0)

merge(MARKET_MAPPING, ZEROED_AR4_DEMAND_ADJUST) %>%
  mutate(price.adjust.year = 1975,
         demand.adjust.year = 1975) %>%
  select(LINK_COLS) ->
  baseline_linking

merge(MARKET_MAPPING, AR4_DEMAND_ADJUST) %>%
  left_join(GHG_GROUP_MAPPING, by = "linked.ghg.policy")%>%
  inner_join(NDC_link_data %>% filter(market %in% UNAGGREGATED_CONSTRAINTS), by = c("group", region = "GCAM_region", "market")) %>%
  mutate(demand.adjust.year = if_else(accounted == 1, NDC_START_YEAR, FIRST_PERIOD_AFTER_NDC_END),
         price.adjust.year = if_else(accounted == 1, NDC_START_YEAR, FIRST_PERIOD_AFTER_NDC_END)) %>% #NOTE: This assumes any gas not specifically addressed is not accounted for. Practically (as of 08/07/19) this only affects CF4 and C2F6
  #na.omit() %>%
  select(LINK_COLS) %>%
  unique() ->
  individual_linking

#All other regions are assumed to limit all GHGs and LUC emissions
merge(MARKET_MAPPING, AR4_DEMAND_ADJUST) %>%
  filter(!region %in% individual_linking$region) %>%
  mutate(price.adjust.year = NDC_START_YEAR,
         demand.adjust.year = NDC_START_YEAR) ->
  aggregate_linking

bind_rows(baseline_linking, individual_linking, aggregate_linking) %>%
  unique() %>%
  arrange(region) %>%
  select("region", "linked-ghg-policy"="linked.ghg.policy", "price-adjust-year"="price.adjust.year",
         "price-adjust"="price.adjust", "demand-adjust-year" = "demand.adjust.year",
         "demand-adjust"="demand.adjust", "market",
         "linked-policy"="linked.policy", "price-unit"="price.unit", "output-unit"="output.unit") %>%
  filter(!market %in% OMITTED_MARKETS) ->
  GHG_linking_file_final


####Calculate each country's share of the regional emissions####
HISTORICAL_EMISSIONS_DATA <- tibble(GHG = character(), ISO_A3 = character(), year = integer(), value = double())
for(file_name in list.files(file.path(HIST_EMIS, "EDGAR"))){
  read.csv(file.path(HIST_EMIS, "EDGAR",file_name), comment.char = "#") %>%
    gather_years() %>%
    mutate(GHG = gsub("EDGAR_", "", gsub("\\.csv", "", file_name))) %>%
    select(GHG, ISO_A3, year, value) %>%
    na.omit() %>%
    group_by(GHG, ISO_A3, year) %>%
    summarise(value = sum(value)) %>%
    ungroup() %>%
    bind_rows(HISTORICAL_EMISSIONS_DATA) ->
    HISTORICAL_EMISSIONS_DATA
}
#CO2 has to account for sequestration, so add a processed version separately
read.csv(file.path(HIST_EMIS, "L100.CDIAC_CO2_ctry_hist.csv"), comment.char = "#") %>%
  mutate(liquids.sequestration = liquids.sequestration*-1, ISO_A3 = iso ) %>%
  gather(sector, value, -c(iso, ISO_A3, year)) %>%
  group_by(ISO_A3, year) %>%
  summarise(value = sum(value)) %>%
  ungroup() %>%
  mutate(GHG = "CO2") %>%
  bind_rows(HISTORICAL_EMISSIONS_DATA) ->
  HISTORICAL_EMISSIONS_DATA


HISTORICAL_EMISSIONS_DATA %>%
  #All units of gases are in Gg (for co2 it's Gg C) so convert demand adjusts
  left_join(AR4_DEMAND_ADJUST %>%
              mutate(demand.adjust = if_else(!grepl("^Gg", output.unit), demand.adjust/1000, demand.adjust)) %>%
              select(GHG = linked.ghg.policy, demand.adjust)) %>%
  mutate(value = value*demand.adjust, units = "MTCO2 eq", iso = tolower(ISO_A3)) %>%
  left_join(ISO_REGION_MAPPING) %>% #There are two isos not mapped "air" and "sea" which come from international trade
  na.omit() %>%
  group_by(year, iso, country_name, region) %>%
  summarise(value = sum(value)) %>%
  group_by(year, region) %>%
  mutate(share = value/sum(value)) %>%
  ungroup() %>%
  select(year, iso, country_name, region, share) ->
  share_emissions_C

####Format emissions and GDP queries####
emissions %>%
  rename(year = Year) %>%
  filter(region != "Global") %>%
  bind_rows(select(LU_emissions, -LandLeaf) %>% rename(year = Year) %>% mutate(GHG = "CO2_LUC")) %>%
  left_join(GHG_linking_file_final %>% select('region', "linked-ghg-policy", "demand-adjust"), by = c("region", "GHG"="linked-ghg-policy")) %>%
  mutate(value = value * `demand-adjust`) %>%
  filter(!is.na(value)) %>%
  left_join(MARKET_MAPPING, by = "region") %>%
  group_by(scenario, market, year) %>%
  summarise(value = sum(value)) %>%
  ungroup() ->
  BASE_EMISSIONS

if(BASE_EMISSIONS$scenario %>% unique() %>% length() != 1){
  break("Only a reference scenario should be added")
} else BASE_EMISSIONS <- BASE_EMISSIONS %>% select(-scenario)

gdp_mer %>%
  rename(year = Year) %>%
  left_join(MARKET_MAPPING, by = "region") %>%
  group_by(market, year) %>%
  summarise(gdp = sum(value)) ->
  gdp

left_join(BASE_EMISSIONS, gdp, by = c("market", "year")) %>%
  mutate(ghg_intensity = value/gdp)%>%
  select(market, year, ghg_intensity) ->
  ghg_gdp_intensity

####Calculate NDCs up to 2030####
#The basic structure of calculating the NDCs is separated by countries who are aggregated into GCAM regions,
#and countries that are individual GCAM regions already
# NOTE: The EU and Australia_NZ are treated as individual regions rather than aggregated regions

#Strategy for aggregated countries:
# Assume that all regions commited to all GHGs and LUC with AR4
#to simplify aggregating different commitments. Aggregate country level reductions into regions,
#then subtract the reductions from GCAM's BAU.We will assume all precentage reductions are relative to
#GCAM's 2030 BAU.

#Strategy for unaggregated regions:
# Rather than subtract reductions from GCAM's BAU, use each country's commitments as their constraint.


#The rule column separates how different countries calculate their constraints
#   1) a reduction relative to a base year or absolute emissions limit
#   2) a reduction relative to the BAU scenario where the country specified its own BAU
#   3) a reduction where the country did not specify BAU
#   3a) a reduction with no quantifiable values
# Omit rule 3 (and 3a) as we cannot get values to return to GCAM
INDC_DATA %>%
  filter(! rule %in% c("3a")) %>%
  select(country, region = GCAM_region, target_year, target_type, ref_emiss, UC = INDC_UC, CN = INDC_CN) %>%
  mutate(CN = as.double(CN),
         UC = as.double(UC)) %>%
  left_join(MARKET_MAPPING, by = "region") %>%
  gather(conditional, value, -c("country", "region", "market", "target_year", "ref_emiss", "target_type")) %>%
  filter(!is.na(value)) ->
  #Mali only commited to a total reduction (rather than a percentage reduction)
  # to (mathematically) ensure that no region goes negative we will omit it.
  NDC_country

#Calculate reductions for aggregated regions
# Note that some countries have committed to an intensity of GDP reduction but this isn't possible to
# calculate in aggregated regions in GCAM as it stands. This calculation will only occur for unaggregated regions
NDC_country %>%
  filter(!market %in% UNAGGREGATED_CONSTRAINTS) %>%
  select(-ref_emiss, -target_year, -target_type) %>% # We base it off of BAU for aggregated regions, so we dont need these
  left_join(share_emissions_C %>% group_by(country_name) %>% filter(year == max(year)) %>% ungroup, by = c("country" = "country_name", "region")) %>%
  na.omit() %>% #liechtenstein, Montenegro, and Serbia dont have past emissions and so are omitted here
  left_join(BASE_EMISSIONS %>% filter(year == 2030) %>% select(market, bau = value), by = "market") %>%
  mutate(units = "MtCO2e",
         reduction = value*share*bau,
         year = 2030) %>%
  group_by(market, conditional, year, units) %>%
  summarise(reduction = sum(reduction)) %>%
  ungroup() ->
  aggregate_NDC_reduction

#First account for the Coppenhagen committments
# This is a simple first pass that takes the Copenhagen constraints from the old model and applies them here
# TODO: scale or somehow otherwise alter the coppenhagen committments to match the new emissions pathways
BASE_EMISSIONS %>%
  left_join(COPPENHAGEN_DATA %>% select(market, year, value), by = c("market", "year")) %>%
  mutate(value = if_else(!is.na(value.y)&(value.y<value.x), value.y, value.x)) %>%
  select(market, year, value) ->
  coppenhagen_emissions

#Subtract the reductions from Coppenhagen adjusted GCAM BAU emissions to get GCAM constraints
aggregate_NDC_reduction %>%
  left_join(coppenhagen_emissions %>% filter(year==2030), by = c("market", "year")) %>%
  mutate(value = value+reduction) %>%
  select(-reduction) %>%
  spread(year, value) %>%
  left_join(coppenhagen_emissions %>% filter(year == 2020) %>% spread(year, value), by = c("market")) %>%
  mutate(`2025` = (`2030`+`2020`)/2) %>%
  gather(year, value, -c(market, units, conditional)) %>%
  mutate(year = as.integer(year))->
  aggregate_NDC_R_C_Y

#Calculate constraints for unaggregated regions
# Note that India and China have committed to an intensity of GDP reduction
NDC_country %>%
  filter(market %in% UNAGGREGATED_CONSTRAINTS) %>%
  mutate(units = "MtCO2e",
         constraint =if_else(!is.na((1+value) * ref_emiss),
                               (1+value) * ref_emiss,
                               if_else(!is.na(value),
                                       if_else(value>0 & value<ref_emiss,
                                               value,
                                               ref_emiss + value),
                                       ref_emiss))) %>%
  #Because the previous mutate is rather complex the GDP reduction countries
  # will simply overwrite the above constraint.
  left_join(ghg_gdp_intensity, by =c("market", target_year ="year")) %>%
  left_join(gdp, by =c("market", target_year = "year")) %>%
  mutate(constraint = if_else(target_type == "intensity_GDP",
                                 if_else(!is.na((1+value) * ghg_intensity * gdp),
                                         (1+value) * ghg_intensity * gdp,
                                         ref_emiss), #Should we default to their ref_emissions their reductions are NA or should we just be unbounded
                                 constraint)) %>%
  group_by(market, target_year, conditional, units) %>%
  summarise(constraint = sum(constraint)) %>%
  ungroup() %>%
  spread(target_year, constraint) ->
  individual_NDC_constraints_R_C

#Most regions target 2030, but the US targets 2025, so treat it seperately
#calculate 2030 by linearly extrapolating the emissions reduction between 2005 and 2025
individual_NDC_constraints_R_C %>%
  filter(is.na(`2030`), market == "USA") %>%
  left_join(coppenhagen_emissions %>% filter(year %in% c(2005, 2020)) %>% spread(year, value), by = "market") %>%
  mutate(`2030` = `2025` + ((`2025`- `2005`)/(2025-2005))*(2030-2025)) %>%
  gather(year, value, -c("market", "units", "conditional")) %>%
  mutate(year = as.integer(year)) %>%
  filter(year >= 2020) %>%
  select(market, units, conditional, year, value) ->
  NDC_individual_2025

#Now do regions targeting 2030
individual_NDC_constraints_R_C %>%
  filter(!is.na(`2030`), market != "USA") %>%
  left_join(coppenhagen_emissions %>% filter(year == 2020) %>% spread(year, value), by = "market") %>%
  mutate(`2025` = if_else(is.na(`2025`), (`2030`+`2020`)/2, `2025`)) %>%
  gather(year, value, -c("market", "units", "conditional")) %>%
  mutate(year = as.integer(year)) ->
  NDC_individual_2030

NDC_constraints <- bind_rows(NDC_individual_2025, NDC_individual_2030, aggregate_NDC_R_C_Y)

#Indonesia says that it will be emitting more than GCAM's BAU, so replace any over emissions with baselines
NDC_constraints %>%
  left_join(coppenhagen_emissions, by = c("market", "year")) %>%
  mutate(value = if_else(value.y<value.x, value.y, value.x)) %>%
  select(names(NDC_constraints)) ->
  NDC_constraints

BASE_EMISSIONS %>%
  mutate(market = as.character(market)) %>%
  filter(!market %in% unique(pull(NDC_constraints, market))) %>%
  pull(market) %>%
  unique() ->
  uncommitted_regions

#There are 3 regions in GCAM that have no listed NDC commitments.They are added here
# to calculate whatever goal is attempted post 2030, but are filtered out before writing the outputs
BASE_EMISSIONS %>%
  merge(tibble(conditional = c("CN", "UC"))) %>%
  filter(!market %in% NDC_constraints$market, year %in% NDC_constraints$year) %>%
  mutate(units = "MtCO2e") %>%
  bind_rows(NDC_constraints) ->
  NDC_constraints

####Calculate NDCs for continued ambition, increased ambition, NDC->2deg, and NDC->1.5deg####
#Different scenarios have different paths for emissions past 2030
#(continued ambition, increased ambition, 2degree scenario, 1.5 degree scenario)
# the first two decarbonize their economy (emissions/$GDP) at the rate they did between 2020 and 2030 (with a minimum of 2% and 5% respectively)
# the latter two decarbonize linearly to 5 MtCO2e in 2070 and 2050 respectively

#Get the ghg_intensity (emissions/unit GDP)
NDC_constraints %>%
  rename(ndc = value) %>%
  left_join(gdp , by = c("market", "year")) %>%
  mutate(ghg_intensity =ndc/gdp, units = "MtCO2e/mil1990$US") %>%
  select(market, conditional, year, ndc, ghg_intensity) ->
  ghg_intens

#Calculate the annual decarbonization rate from the decrease in ghg_intensity
ghg_intens %>%
  select(market, conditional, year, ghg_intensity) %>%
  spread(year, ghg_intensity) %>%
  mutate(ndc_rate = round(1 - (`2030`/`2020`)^(1/10), digits = 2)) %>%
  select(market, conditional, ndc_rate) ->
  decarbonization_rate

#Join together the GDP and decarbonization rate with the ghg intensity to prepare
# calculating by scenario. Additionally filter out any omitted markets
NDC_constraints %>%
  select(market, year, conditional, value) %>%
  group_by(market, year, conditional) %>%
  complete(year = seq(2020, 2100, 5)) %>%
  ungroup() %>%
  left_join(gdp, by = c("market", "year")) %>%
  left_join(decarbonization_rate, by = c("market", "conditional")) %>%
  left_join(ghg_intens %>% filter(year == 2030) %>% select(market, conditional, ghg_intensity), by = c("market", "conditional")) %>%
  left_join(MARKET_MAPPING %>% filter(!duplicated(market)) %>% mutate(ghgpolicy = "GHG"), by = "market") %>%
  filter(!market %in% OMITTED_MARKETS) ->
  NDC_commitments

#Calculate cont_ambition (minium 2% decarbonization rate)
NDC_commitments %>%
  mutate(ndc_rate = if_else(year >2030 & ndc_rate < .02, .02, ndc_rate ),
         ghg_intensity = ghg_intensity * (1-ndc_rate)^(year-2030),
         value = if_else(year > 2030,
                         if_else(is.na(value),
                                 gdp*ghg_intensity,
                                 if_else(gdp*ghg_intensity<value,
                                         gdp*ghg_intensity,
                                         value)),
                         value)) %>%
  select(region, ghgpolicy, conditional, market, year, value) %>%
  unique() %>%
  #Filter out any region that did not have any NDC commitments
  filter(!(market %in% uncommitted_regions & year <= NDC_END_YEAR)) %>%
  # mutate(value = value *0.8) %>%
  filter(year > 2020) ->
  NDC_cont_ambitions

#Calculate cont_ambition (minium 2% decarbonization rate) with Global markets (regions can 'trade' emissions)
NDC_commitments %>%
  mutate(ndc_rate = if_else(year >2030 & ndc_rate < .02, .02, ndc_rate ),
         ghg_intensity = ghg_intensity * (1-ndc_rate)^(year-2030),
         value = if_else(year > 2030,
                         if_else(is.na(value),
                                 gdp*ghg_intensity,
                                 if_else(gdp*ghg_intensity<value,
                                         gdp*ghg_intensity,
                                         value)),
                         value)) %>%
  select(region, ghgpolicy, conditional, market, year, value) %>%
  unique() %>%
  #The region is arbitrary. It could be placed in any region
  mutate(market = "Global", region = "EU-12") %>%
  group_by(region, ghgpolicy, conditional, market, year) %>%
  summarise(value = sum(value)) %>%
  ungroup() ->
  NDC_cont_ambitions_global

#calculate increased ambition (minimum 5% decarbonization rate)
NDC_commitments %>%
  mutate(ndc_rate = if_else(year >2030 & ndc_rate < .05, .05, ndc_rate ),
         ghg_intensity = ghg_intensity * (1-ndc_rate)^(year-2030),
         value = if_else(year > 2030,
                         if_else(is.na(value),
                                 gdp*ghg_intensity,
                                 if_else(gdp*ghg_intensity<value,
                                         gdp*ghg_intensity,
                                         value)),
                         value)) %>%
  select(region, ghgpolicy, conditional, market, year, value) %>%
  unique() %>%
  #Filter out any region that did not have any NDC commitments
  filter(!(market %in% uncommitted_regions & year <= NDC_END_YEAR)) ->
  NDC_incr_ambitions

#calculate NDC to 2 degree pathways
#(note: this is not an exact science and will need to be tweaked with changes in branch or hector)
NDC_commitments %>%
  group_by(market, conditional) %>%
  mutate(value = if_else(year >= 2070,
                         5,
                         value),
         value_test = if_else(!between(year, 2031, 2069), value, as.double(NA)),
         value = approx(year,value,year)$y,
         value_test = approx(year,value_test,year)$y,
         value = if_else(value_test<value, value_test, value)) %>%
  ungroup() %>%
  select(region, ghgpolicy, conditional, market, year, value) %>%
  unique()%>%
  #Filter out any region that did not have any NDC commitments
  filter(!(market %in% uncommitted_regions & year <= NDC_END_YEAR)) ->
  NDC_2_deg

#calculate NDC to 1.5 degree pathways
#(note: this is not an exact science and will need to be tweaked with changes in branch or hector)
NDC_commitments %>%
  group_by(market, conditional) %>%
  mutate(value = if_else(year >= 2050,
                         5,
                         value),
         value_test = if_else(!between(year, 2031, 2049), value, as.double(NA)),
         value = approx(year,value,year)$y,
         value_test = approx(year,value_test,year)$y,
         value = if_else(value_test<value, value_test, value)) %>%
  ungroup() %>%
  select(region, ghgpolicy, conditional, market, year, value) %>%
  unique()%>%
  #Filter out any region that did not have any NDC commitments
  filter(!(market %in% uncommitted_regions & year <= NDC_END_YEAR))->
  NDC_1p5_deg

NDC_cont_ambitions_UC <- filter(NDC_cont_ambitions, conditional == "UC") %>% select(-conditional) %>% mutate(value = round(value))
NDC_cont_ambitions_CN <- filter(NDC_cont_ambitions, conditional == "CN") %>% select(-conditional) %>% mutate(value = round(value))
NDC_cont_ambitions_global_UC <- filter(NDC_cont_ambitions_global, conditional == "UC") %>% select(-conditional) %>% mutate(value = round(value))
NDC_cont_ambitions_global_CN <- filter(NDC_cont_ambitions_global, conditional == "CN") %>% select(-conditional) %>% mutate(value = round(value))
NDC_incr_ambitions_UC <- filter(NDC_incr_ambitions, conditional == "UC") %>% select(-conditional) %>% mutate(value = round(value))
NDC_incr_ambitions_CN <- filter(NDC_incr_ambitions, conditional == "CN") %>% select(-conditional) %>% mutate(value = round(value))
NDC_2_deg_UC <- filter(NDC_2_deg, conditional == "UC") %>% select(-conditional) %>% mutate(value = round(value))
NDC_2_deg_CN <- filter(NDC_2_deg, conditional == "CN") %>% select(-conditional) %>% mutate(value = round(value))
NDC_1p5_deg_UC <- filter(NDC_1p5_deg, conditional == "UC") %>% select(-conditional) %>% mutate(value = round(value))
NDC_1p5_deg_CN <- filter(NDC_1p5_deg, conditional == "CN") %>% select(-conditional) %>% mutate(value = round(value))
#===========================================================================

#Write the outputs as csvs
#===========================================================================
# write_const_csv(NDC_cont_ambitions_UC, file.path(OUTPUT_DIR, "NDC_cont_UC.csv"), row.names = FALSE)
# write_const_csv(NDC_cont_ambitions_CN, file.path(OUTPUT_DIR, "NDC_cont_CN.csv"), row.names = FALSE)
# write_const_csv(NDC_incr_ambitions_UC, file.path(OUTPUT_DIR, "NDC_incr_UC.csv"), row.names = FALSE)
# write_const_csv(NDC_incr_ambitions_CN, file.path(OUTPUT_DIR, "NDC_incr_CN.csv"), row.names = FALSE)
# write_const_csv(NDC_2_deg_UC, file.path(OUTPUT_DIR, "NDC_2deg_UC.csv"), row.names = FALSE)
# write_const_csv(NDC_2_deg_CN, file.path(OUTPUT_DIR, "NDC_2deg_CN.csv"), row.names = FALSE)
# write_const_csv(NDC_1p5_deg_UC, file.path(OUTPUT_DIR, "NDC_1p5deg_UC.csv"), row.names = FALSE)
# write_const_csv(NDC_1p5_deg_CN, file.path(OUTPUT_DIR, "NDC_1p5deg_CN.csv"), row.names = FALSE)
# write_header_csv(GHG_linking_file_final, file.path(OUTPUT_DIR, "GHG_link.csv"), LINK_FILE_HEADER, row.names = FALSE)
#===========================================================================

####Write the outputs as xmls####
#===========================================================================
shared_markets <- MARKET_MAPPING %>% filter(duplicated(market), !market %in% OMITTED_MARKETS) %>% mutate(ghgpolicy = "GHG") %>% select(region, ghgpolicy, market)
global_market <- data.frame(region = MARKET_MAPPING$region[((!MARKET_MAPPING$region %in% NDC_cont_ambitions_global$region) & !(MARKET_MAPPING$region %in% OMITTED_MARKETS))],
                                ghgpolicy = "GHG",
                                market = "Global")

gcamdata::create_xml(file.path(OUTPUT_DIR, "NDC_cont_UC.xml")) %>%
  gcamdata::add_xml_data(NDC_cont_ambitions_UC, "GHGConstrLong", NULL) %>%
  gcamdata::add_xml_data(shared_markets, "GHGConstrMkt", NULL) %>%
  gcamdata::run_xml_conversion()
gcamdata::create_xml(file.path(OUTPUT_DIR, "NDC_cont_CN.xml")) %>%
  gcamdata::add_xml_data(NDC_cont_ambitions_CN, "GHGConstrLong", NULL) %>%
  gcamdata::add_xml_data(shared_markets, "GHGConstrMkt", NULL) %>%
  gcamdata::run_xml_conversion()
gcamdata::create_xml(file.path(OUTPUT_DIR, "NDC_cont_global_UC.xml")) %>%
  gcamdata::add_xml_data(NDC_cont_ambitions_global_UC, "GHGConstrLong", NULL) %>%
  gcamdata::add_xml_data(global_market, "GHGConstrMkt", NULL) %>%
  gcamdata::run_xml_conversion()
gcamdata::create_xml(file.path(OUTPUT_DIR, "NDC_cont_global_CN.xml")) %>%
  gcamdata::add_xml_data(NDC_cont_ambitions_global_CN, "GHGConstrLong", NULL) %>%
  gcamdata::add_xml_data(global_market, "GHGConstrMkt", NULL) %>%
  gcamdata::run_xml_conversion()
gcamdata::create_xml(file.path(OUTPUT_DIR, "NDC_incr_UC.xml")) %>%
  gcamdata::add_xml_data(NDC_incr_ambitions_UC, "GHGConstrLong", NULL) %>%
  gcamdata::add_xml_data(shared_markets, "GHGConstrMkt", NULL) %>%
  gcamdata::run_xml_conversion()
gcamdata::create_xml(file.path(OUTPUT_DIR, "NDC_incr_CN.xml")) %>%
  gcamdata::add_xml_data(NDC_incr_ambitions_CN, "GHGConstrLong", NULL) %>%
  gcamdata::add_xml_data(shared_markets, "GHGConstrMkt", NULL) %>%
  gcamdata::run_xml_conversion()
gcamdata::create_xml(file.path(OUTPUT_DIR, "NDC_2_deg_UC.xml")) %>%
  gcamdata::add_xml_data(NDC_2_deg_UC, "GHGConstrLong", NULL) %>%
  gcamdata::add_xml_data(shared_markets, "GHGConstrMkt", NULL) %>%
  gcamdata::run_xml_conversion()
gcamdata::create_xml(file.path(OUTPUT_DIR, "NDC_2_deg_CN.xml")) %>%
  gcamdata::add_xml_data(NDC_2_deg_CN, "GHGConstrLong", NULL) %>%
  gcamdata::add_xml_data(shared_markets, "GHGConstrMkt", NULL) %>%
  gcamdata::run_xml_conversion()
gcamdata::create_xml(file.path(OUTPUT_DIR, "NDC_1p5_deg_UC.xml")) %>%
  gcamdata::add_xml_data(NDC_1p5_deg_UC, "GHGConstrLong", NULL) %>%
  gcamdata::add_xml_data(shared_markets, "GHGConstrMkt", NULL) %>%
  gcamdata::run_xml_conversion()
gcamdata::create_xml(file.path(OUTPUT_DIR, "NDC_1p5_deg_CN.xml")) %>%
  gcamdata::add_xml_data(NDC_1p5_deg_CN, "GHGConstrLong", NULL) %>%
  gcamdata::add_xml_data(shared_markets, "GHGConstrMkt", NULL) %>%
  gcamdata::run_xml_conversion()


gcamdata::create_xml(file.path(OUTPUT_DIR, "GHG_link.xml")) %>%
  gcamdata::add_xml_data(GHG_linking_file_final, "GHGLink_start", NULL) %>%
  gcamdata::run_xml_conversion()
gcamdata::create_xml(file.path(OUTPUT_DIR, "GHG_link_global.xml")) %>%
  gcamdata::add_xml_data(GHG_linking_file_final %>% mutate(market = "Global"), "GHGLink_start", NULL) %>%
  gcamdata::run_xml_conversion()
#===========================================================================
